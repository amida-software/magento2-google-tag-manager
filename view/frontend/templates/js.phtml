<script>
    (function () {
        if (window.__gtmCartHookInstalled) return;
        window.__gtmCartHookInstalled = true;

        const dataLayerName = <?= json_encode($dataLayerName) ?>;
        const cartEventEndpoint = <?= json_encode($block->getUrl('gtm/cart/event')) ?>;

        function getDL() {
            window[dataLayerName] = window[dataLayerName] || [];
            return window[dataLayerName];
        }

        function isCart(url) {
            url = String(url || '');
            return /\/checkout\/(?:cart\/(?:add|delete|update|updateItemQty|remove)|sidebar\/(?:updateItemQty|removeItem))/.test(url);
        }

        function isOtp(url) {
            try {
                const u = new URL(url, location.origin);
                return /\/otplogin\/account\/sendotpcreate$/i.test(u.pathname);
            } catch (e) {
                return /\/otplogin\/account\/sendotpcreate\b/i.test(String(url || ''));
            }
        }

        function pingCart(originalUrl) {
            const url = cartEventEndpoint + '?src=' + encodeURIComponent(originalUrl || '');
            fetch(url, { credentials: 'same-origin' })
                .then(r => r.json())
                .then(payload => {
                    if (!payload || !payload.event) return;
                    const dl = getDL();
                    dl.push({ ecommerce: null });
                    dl.push(payload);
                })
                .catch(() => {});
        }

        function pushGenerateLead() {
            const dl = getDL();
            dl.push({ ecommerce: null });
            dl.push({
                event: 'generate_lead',
                ecommerce: {
                    currency: 'UAH',
                    value: 0
                }
            });
        }

        function handleOtpResponse(text, ok) {
            if (!ok) return;
            try {
                const j = JSON.parse(text || '{}');
                const success =
                    j.success === true ||
                    j.status === true ||
                    j.status === 'success' ||
                    j.error === false ||
                    j.error === 0 ||
                    j.code === 200;
                if (success) pushGenerateLead();
            } catch (_) {}
        }

        if (window.fetch) {
            const originalFetch = window.fetch;
            window.fetch = function (input, init) {
                const url = (typeof input === 'string') ? input : (input && input.url) || '';
                const cartCall = isCart(url);
                const otpCall  = isOtp(url);

                return originalFetch(input, init).then(response => {
                    if (cartCall) {
                        try { response.clone().text().finally(() => pingCart(url)); }
                        catch (e) { pingCart(url); }
                    }
                    if (otpCall) {
                        try { response.clone().text().then(t => handleOtpResponse(t, response.ok)); }
                        catch (e) {}
                    }
                    return response;
                });
            };
        }

        if (window.XMLHttpRequest) {
            const origOpen = XMLHttpRequest.prototype.open;
            const origSend = XMLHttpRequest.prototype.send;

            XMLHttpRequest.prototype.open = function (method, url) {
                this.__isCart = isCart(url || '');
                this.__isOtp  = isOtp(url || '');
                this.__origUrl = url || '';
                return origOpen.apply(this, arguments);
            };

            XMLHttpRequest.prototype.send = function () {
                this.addEventListener('load', () => {
                    if (this.__isCart) pingCart(this.__origUrl);
                    if (this.__isOtp)  handleOtpResponse(String(this.responseText || ''), this.status >= 200 && this.status < 300);
                });
                return origSend.apply(this, arguments);
            };
        }

        if (!window.__gtmCartPingDone) {
            window.__gtmCartPingDone = true;
            document.addEventListener('DOMContentLoaded', () => {
                pingCart(location.pathname + location.search);
            });
        }
    })();
</script>
