<?php
/**
 * Copyright Â© MagePal LLC. All rights reserved.
 * See COPYING.txt for license details.
 * http://www.magepal.com | support@magepal.com
 */

/** @var $block MagePal\GoogleTagManager\Block\DataLayer **/
$dataLayerName = $block->getDataLayerName();
$accountId = $block->getAccountId();
$containerCode = $block->getEmbeddedCode();
?>

<!-- Google Tag Manager by MagePal -->

<script type="text/javascript">
    window.<?= /* @noEscape */ $dataLayerName ?> = window.<?= /* @noEscape */ $dataLayerName ?> || [];
    window.<?= /* @noEscape */ $dataLayerName ?>.push({ ecommerce: null });\

<?php if (!$block->isGdprEnabled() && $block->addJsInHead() && !$block->isAdvancedSettingsEnabled()): ?>
    <?= /* @noEscape */ $block->getDataLayerJs() ?>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='<?= /* @noEscape */ $dataLayerName ?>'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl<?= /* @noEscape */ $containerCode ? "+'{$containerCode}'" : '' ?>;f.parentNode.insertBefore(j,f);
    })(window,document,'script','<?= /* @noEscape */ $dataLayerName ?>','<?= /* @noEscape */ $accountId ?>');
<?php endif; ?>
</script>

<?php if ($block->isAdvancedSettingsEnabled()): ?>
    <?= /* @noEscape */ $block->getDataLayerJs() ?>
    <?= /* @noEscape */ $block->getAdvancedSettingsJsCode() ?>
<?php endif; ?>

<?php if (($block->isGdprEnabled() || !$block->addJsInHead()) && !$block->isAdvancedSettingsEnabled()) : ?>
<script type="text/x-magento-init">
    {
        "*": {
            "magepalGtmDatalayer": {
                "isCookieRestrictionModeEnabled": <?= /* @noEscape */ $block->isCookieRestrictionModeEnabled() ?>,
                "currentWebsite": <?= /* @noEscape */ $block->getCurrentWebsiteId() ?>,
                "cookieName": "<?= /* @noEscape */ $block->getCookieRestrictionName() ?>",
                "dataLayer": "<?= /* @noEscape */ $block->getDataLayerName() ?>",
                "accountId": "<?= /* @noEscape */ $block->getAccountId() ?>",
                "data": <?= /* @noEscape */ $block->getDataLayerJson() ?>,
                "isGdprEnabled": <?= /* @noEscape */ $block->isGdprEnabled() ?>,
                "gdprOption": <?= /* @noEscape */ $block->getGdprOption() ?>,
                "addJsInHeader": <?= /* @noEscape */ $block->addJsInHead() ?>,
                "containerCode": "<?= /* @noEscape */ $block->getEmbeddedCode() ?>"
            }
        }
    }
</script>
<?php else : ?>
<script type="text/x-magento-init">
    {
        "*": {
            "magepalGtmDatalayer": {
                "dataLayer": "<?= /* @noEscape */ $block->getDataLayerName() ?>"
            }
        }
    }
</script>
<?php $block->clearDataLayerSessionInfo(); ?>
<?php endif; ?>
<script>
    (function(){
        var DL = <?= json_encode($dataLayerName) ?>;
        window[DL] = window[DL] || [];
        function push(v){ window[DL].push(v); }

        var OTP_FLAG='__gtmOtpFlow', LOGIN_FLAG='__gtmLoginPending';
        function set(k,v){ try{ sessionStorage.setItem(k,v) }catch(e){} }
        function get(k){ try{ return sessionStorage.getItem(k) }catch(e){ return null } }
        function del(k){ try{ sessionStorage.removeItem(k) }catch(e){} }

        function isOtpUrl(u){ u=String(u||''); return /\/otplogin\/account\/(?:sendotp|otplogin)(?:\/|\?|$)/i.test(u) }
        function isOtpLogin(u){ u=String(u||''); return /\/otplogin\/account\/otplogin(?:\/|\?|$)/i.test(u) }
        function isLoginPost(u){ u=String(u||''); return /\/customer\/account\/loginPost(?:\/|\?|$)/i.test(u) }

        if (window.fetch){
            var _f = window.fetch;
            window.fetch = function(i,init){
                var url = (typeof i==='string') ? i : (i && i.url) || '';
                if (isOtpUrl(url)) set(OTP_FLAG,'1');
                if (isLoginPost(url)) set(LOGIN_FLAG,'Google');

                return _f(i,init).then(function(r){
                    if (isOtpLogin(url)){
                        var ok = r.ok;
                        try {
                            r.clone().text().then(function(){
                                if (ok){
                                    push({ecommerce:null});
                                    push({event:'login', ecommerce:{method:'Phone'}});
                                    del(LOGIN_FLAG); del(OTP_FLAG);
                                }
                            });
                        } catch(e){}
                    }
                    return r;
                });
            };
        }

        var XO = XMLHttpRequest.prototype.open, XS = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.open = function(m,u){
            this.__u = u || '';
            if (isOtpUrl(this.__u)) set(OTP_FLAG,'1');
            if (isLoginPost(this.__u)) set(LOGIN_FLAG,'Google');
            return XO.apply(this, arguments);
        };
        XMLHttpRequest.prototype.send = function(){
            var self = this;
            self.addEventListener('load', function(){
                if (isOtpLogin(self.__u) && self.status>=200 && self.status<300){
                    push({ecommerce:null});
                    push({event:'login', ecommerce:{method:'Phone'}});
                    del(LOGIN_FLAG); del(OTP_FLAG);
                }
            });
            return XS.apply(this, arguments);
        };

        document.addEventListener('DOMContentLoaded', function(){
            var pending = get(LOGIN_FLAG);
            var isOtp = get(OTP_FLAG) === '1';
            if (pending && !isOtp){
                push({ecommerce:null});
                push({event:'login', ecommerce:{method: pending}});
                del(LOGIN_FLAG);
            }
        });
    })();
</script>

<!-- End Google Tag Manager by MagePal -->
